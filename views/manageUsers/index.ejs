<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>SB Admin 2 - Dashboard</title>

    <%include ../partials/css%>

</head>

<body id="page-top">

    <!-- Page Wrapper -->
    <div id="wrapper">

        <%include ../partials/sideMenu%>

            <!-- Content Wrapper -->
            <div id="content-wrapper" class="d-flex flex-column">

                <!-- Main Content -->
                <div id="content">

                    <!-- Topbar -->
                    <%include ../partials/topBar%>
                        <!-- End of Topbar -->

                        <!-- Begin Page Content -->
                        <div class="container-fluid">
                            <div class="row">
                                <div class="col-12">
                                    <div class="card">
                                        <div class="card-header bg-gradient-primary">
                                            <h6 class="text-white">Manage Users</h6>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-12 text-right">
                                        <button class="btn btn-small btn-primary" data-toggle="modal"
                                            data-target="#createUser-modal"><i class="fa fa-plus"></i> Create New
                                            User</button>
                                    </div>
                                </div>
                                <div class="row mt-3">
                                    <div class="table-responsive">
                                        <table id="usersTable"
                                            class="table table-bordered table-striped text-center text-nowrap">
                                            <thead>
                                                <tr>
                                                    <th>#</th>
                                                    <th>User Name</th>
                                                    <th>Email</th>
                                                    <th>Contact</th>
                                                    <th>Action</th>
                                                </tr>
                                            </thead>
                                            <tbody id="usersTableBody"></tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- /.container-fluid -->

                </div>
                <!-- End of Main Content -->

                <!-- Footer -->
                <%include ../partials/footer.ejs%>
                    <%include ./createUserModal.ejs%>
                        <!-- End of Footer -->

            </div>
            <!-- End of Content Wrapper -->

    </div>
    <!-- End of Page Wrapper -->

    <%include ../partials/logOutModal%>

        <%include ../partials/bodyScripts%>
            <script>
                //Method To Get Users List
                let getUsersList = () => {
                    $("#usersTableBody tr").remove();
                    let index = 1;
                    $.ajax({
                        type: "GET",
                        url: "/manageUsers/getAllUsers",
                        success: function (data) {
                            for (let user of data) {
                                $("#usersTableBody").append(`
                                        <tr>
                                            <td>${index++}</td>
                                            <td>${user.username}</td>   
                                            <td>${user.email}</td>   
                                            <td>${user.contact}</td>   
                                            <td>
                                                <button class="btn btn-warning"><i class="fa fa-edit"></i></button>
                                                <button class="btn btn-danger" onclick="deleteUser('${user._id}', '${user.username}')"><i class="fa fa-trash"></i></button>
                                            </td>
                                        </tr>
                                    `)
                            }
                            alertify.success("Users List Loaded Successfully...")
                        },
                        error: (err) => {
                            alert("Something Went Wrong...");
                        }
                    });
                }

                //Method to Delete User
                let deleteUser = (userId, username) => {
                    alertify.confirm("Delte User: " + username, "Do you really want to delete this user", () => {
                        $.ajax({
                            type: "DELETE",
                            url: "/manageUsers/delete/" + userId,
                            success: function () {

                                alertify.alert('Success', 'User Delted Successfully', function () {
                                    getUsersList();
                                });


                            },
                            error: (err) => {
                                console.log(err)
                                alertify.error("Something Went Wrong...");
                            }
                        });
                    }, () => {
                        alertify.notify("Delete Operation Cancelled");
                    })
                }
                $(document).ready(() => {

                    getUsersList();



                    ///Method To Create New User
                    $('#createUserForm').on("submit", function (event) {
                        event.preventDefault();

                        var formValues = $(this).serialize();

                        $.ajax({
                            type: "POST",
                            url: "/manageUsers/create",
                            data: formValues,
                            success: function () {

                                alertify.alert('Success', 'User Created Successfully', function () {
                                    $('#createUserForm')[0].reset();
                                    $('#createUser-modal').modal('hide');
                                    getUsersList();
                                });


                            },
                            error: (err) => {
                                console.log(err)
                                alert("Something Went Wrong...");
                            }
                        });
                    });
                })
            </script>

</body>

</html>